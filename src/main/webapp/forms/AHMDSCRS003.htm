<div id="AHMDSCRS003" class="div-app" data-version="1.0">
    <div class="global_message">

    </div>
    <div id="ahmdscrs003p01" class="subpage subpage-default" data-path="Upload Data Pembawa">
        <div class="panel-control">
            <div class="panel-button form-group-button">
                <button id="ahmdscrs003p01BtnNew"
                        class="btn btn-default btn-primary large-button" style="float:right;" 
                        onclick="ahmdscrs003p01PrepareAdd(this)">New</button>
                <button id="ahmdscrs003p01BtnPrint"
                        class="btn btn-default btn-primary large-button" style="float:right; margin-right: 5px;" 
                        onclick="ahmdscrs003p01Download(this)">Download Template</button>
            </div>
            <br/>
            <div id="ahmdscrs003p01Monitoring" class="monitoring-panel transition">
                <div class="form-group small-font">
                    <label class="control-label">Tanggal Servis</label>
                    <div class="input-group date" id="ahmdscrs003p01ServbgnPanel" style="margin-bottom: 7px;">
                        <input id="ahmdscrs003p01Servbgn" type="text" name="ahmdscrs003p01Servbgn" class="form-control" />
                        <span class="input-group-addon">
                            <span class="glyphicon glyphicon-calendar"></span>
                        </span>
                    </div>
                    <div class="input-group date" id="ahmdscrs003p01ServendPanel">
                        <input id="ahmdscrs003p01Servend" type="text" name="ahmdscrs003p01Servend" class="form-control" />
                        <span class="input-group-addon">
                            <span class="glyphicon glyphicon-calendar"></span>
                        </span>
                    </div>
                </div>
                <div class="form-group small-font">
                    <label for="ahmdscrs003p01jmlFolup" class="control-label">Jml Follow Up</label>
                    <div class="input-group">
                        <select id="ahmdscrs003p01Folupoperand" name="ahmdscrs003p01Folupoperand" class="form-control" style="width: 30%; margin-right: 5px;">
                            <option value="1">&equals;</option>
                            <option value="2">&lt;</option>
                            <option value="3">&gt;</option>
                            <option value="4">&le;</option>
                            <option value="5">&ge;</option>
                        </select>
                        <input type="number" min="0" max="99999" id="ahmdscrs003p01jmlFolup" name="ahmdscrs003p01jmlFolup" style="width: 40%"/>
                    </div>  
                </div>
                <div class="form-group-button">
                    <button class="btn btn-default btn-primary medium-button"
                            id="ahmdscrs003p01Btnsearch"
                            onclick="ahmdscrs003p01Search(this); return false;">Search
                    </button>
                    <button class="btn btn-default btn-primary medium-button"
                            id="ahmdscrs003p01Btnreset"
                            onclick="ahmdscrs003p01Reset(this); return false;">Reset
                    </button>
                </div>
            </div>
            <div id="ahmdscrs003p01Form" class="form-panel transition">
                <div class="col-md-12" id="ahmdscrs003p01Newpanel">
                    <div class="form-group medium-font col-md-3">
                        <label for="ahmdscrs003p01Sourcepembawa" class="control-label">Source File Data Pembawa</label>
                        <div>
                            <select id="ahmdscrs003p01Sourcepembawa" name="ahmdscrs003p01Sourcepembawa" class="form-control">
                                <!--                            <option value="1">DIMS</option>
                                                            <option value="2">Non DIMS</option>-->
                            </select>
                        </div>
                    </div>
                    <div class="form-group medium-font col-md-3">
                        <label class="control-label">Upload File Pembawa <span style="color:red">*)</span></label>
                        <div>
                            <form class="dropzone col-md-10" id="ahmdscrs003p01Upload" enctype="multipart/form-data" style="height: 55px;"></form>
                        </div>
                    </div>
                    <div class="form-group medium-font col-md-3">
                        <button class="btn btn-default btn-primary large-button"
                                id="ahmdscrs003p01BtnLog"
                                onclick="ahmdscrs003p01Log(this); return false;">
                            Lihat Error Log
                        </button>
                    </div>
                </div>
                <div class="col-md-6" style="margin-bottom: 5px;">
                    <div class="form-group medium-font">
                        <label for="ahmdscrs003p01Filter" class="control-label col-sm-1">Filter </label>
                        <div class="col-sm-7">
                            <input id="ahmdscrs003p01Filter" name="ahmdscrs003p01Filter" class="form-control"/>
                        </div>
                    </div>
                </div>
                <div id="table-container">
                    <table id="ahmdscrs003p01TableDatapembawa"
                           data-method="post"
                           data-url="/crs003/paging"
                           data-content-type="application/json"
                           data-data-type="json"
                           data-query-params-type="limit"
                           data-query-params="ahmdscrs003Presearch"
                           data-response-handler="loadData"
                           data-side-pagination="server"
                           data-pagination="true"
                           >
                        <thead>
                            <tr>
                                <th data-field="venginenum" 
                                    data-sortable="true"
                                    data-visible="true"
                                    >No Engine</th>
                                <th data-field="vframenum" 
                                    data-sortable="true"
                                    data-visible="true"
                                    >No Frame</th>
                                <th data-field="vnopol"
                                    data-sortable="true"
                                    data-visible="true"
                                    >No Polisi</th>
                                <th data-field="dlastservice"
                                    data-sortable="true"
                                    >Tgl Servis</th>
                                <th data-field="vname" 
                                    data-sortable="true" 
                                    >Nama Pembawa</th>
                                <th data-field="vrelationtype"
                                    data-visible="false"
                                    >Kode Relasi</th>
                                <th data-field="vrelationdesc"
                                    data-sortable="true"
                                    >Relasi dng Pemilik</th>
                                <th data-field="vpemilik" 
                                    data-sortable="true" 
                                    >Nama Pemilik</th>
                                <th data-field="vaddress" 
                                    data-sortable="true"
                                    >Alamat Pembawa</th>
                                <th data-field="vkelurahan" 
                                    data-sortable="true" 
                                    >Kelurahan Pembawa</th>
                                <th data-field="vkecamatan"
                                    data-sortable="true"
                                    >Kecamatan Pembawa</th>
                                <th data-field="vcity" 
                                    data-sortable="true"
                                    >Kota Pembawa</th>
                                <th data-field="vhpnum" 
                                    data-sortable="true"
                                    >No HP Pembawa</th>
                                <th data-field="nphonenum" 
                                    data-sortable="true"
                                    >No Telp Pembawa</th>
                                <th data-field="nseqflwup" 
                                    data-sortable="true"
                                    >Jumlah Follow Up</th>
                            </tr>
                        </thead>

                    </table>
                    <table id="ahmdscrs003p01TableUploadresult"
                           data-side-pagination="client"
                           data-pagination="true"
                           >
                        <thead>
                            <tr>
                                <th data-field="venginenum"
                                    data-visible="true"
                                    >No Engine</th>
                                <th data-field="vframenum" 
                                    data-visible="true"
                                    >No Frame</th>
                                <th data-field="vnopol"
                                    data-visible="true"
                                    >No Polisi</th>
                                <th data-field="dlastservice"
                                    >Tgl Servis</th>
                                <th data-field="vname" 
                                    data-sortable="true" 
                                    >Nama Pembawa</th>
                                <th data-field="vrelationtype"
                                    data-visible="false"
                                    >Kode Relasi</th>
                                <th data-field="vrelationdesc"
                                    >Relasi dng Pemilik</th>
                                <th data-field="vpemilik" 
                                    >Nama Pemilik</th>
                                <th data-field="vaddress" 
                                    >Alamat Pembawa</th>
                                <th data-field="vkelurahan"
                                    >Kelurahan Pembawa</th>
                                <th data-field="vkecamatan"
                                    data-sortable="true"
                                    >Kecamatan Pembawa</th>
                                <th data-field="vcity" 
                                    >Kota Pembawa</th>
                                <th data-field="vhpnum" 
                                    >No HP Pembawa</th>
                                <th data-field="vphonenum"
                                    >No Telp Pembawa</th>
                                <th data-field="nseqflwup"
                                    >Jumlah Follow Up</th>
                                <th data-field="vaddressPemilik" 
                                    data-visible="false"
                                    >Alamat Pemilik</th>
                                <th data-field="vkelurahanPemilik" 
                                    data-visible="false"
                                    >Kelurahan Pemilik</th>
                                <th data-field="vkecamatanPemilik" 
                                    data-visible="false"
                                    >Kecamatan Pemilik</th>
                                <th data-field="vcityPemilik" 
                                    data-visible="false"
                                    >Kota Pemilik</th>
                                <th data-field="vhpnumPemilik" 
                                    data-visible="false"
                                    >No HP Pemilik</th>
                                <th data-field="vphonenumPemilik" 
                                    data-visible="false"
                                    >No Telp Pemilik</th>
                                <th data-field="ipemilikstnk" 
                                    data-visible="false"
                                    >Pemilik Ke</th>
                                <th data-field="ipembawa" 
                                    data-visible="false"
                                    >Pembawa Ke</th>
                                <th data-field="vidpembawa" 
                                    data-visible="false"
                                    >VID Pembawa</th>
                                <th data-field="vidpemilik" 
                                    data-visible="false"
                                    >VID Pemilik</th>
                            </tr>
                        </thead>
                    </table>
                </div>
                <br/>
                <div class="form-group">
                    <button class="btn btn-default btn-primary large-button"
                            id="ahmdscrs003p01Btnsave"
                            onclick="ahmdscrs003p01Save(this); return false;">Save
                    </button>
                    <button class="btn btn-default btn-primary large-button"
                            id="ahmdscrs003p01Btncancel"
                            onclick="ahmdscrs003p01Cancel(this); return false;">Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    var url="";
    $(document).ready(function(){
        $('#ahmdscrs003p01ServbgnPanel').datetimepicker({ 
            format: 'DD-MMM-YYYY', 
            locale:'id'
        });
        $('#ahmdscrs003p01ServendPanel').datetimepicker({ 
            format: 'DD-MMM-YYYY', 
            locale:'id'
        });
        $('#ahmdscrs003p01Btnsave').hide();
        $('#ahmdscrs003p01Btncancel').hide();
        $('#ahmdscrs003p01BtnLog').hide();
        $('#ahmdscrs003p01TableUploadresult').hide();
        $('#ahmdscrs003p01Newpanel').hide();
    });
    $('#ahmdscrs003p01Upload').dropzone({ 
        url: baseURL+"/crs003/upload",
        method:"post",
        maxFilesize: 100,
        paramName: "fileToUpload",
        uploadMultiple: false,
        maxFiles:1,
        previewTemplate: "<div class=\"\">"+
            "<div style=\"float:left\" class=\"dz-filename\">"+
            "<span data-dz-name></span>"+
                               
                                    
            "</div>"+
            "</div>",
        
        init: function() {
            this.on("maxfilesexceeded", function(file) {
                this.removeAllFiles();
                this.addFile(file);
            });
            this.on('success', function(file, json) {
                if(json.stat == "200"){
                    //                    _fw_subpage($('#ahmdsh1c003Upload'), 'ahmdsh1c028p01');
                    var listTempDetail = json.rows;
                    var listDetail = [];
                    if(listTempDetail.length > 0){
                        $.each(listTempDetail, function(index, row){                                        
                            var tempRow = new Object();
                            tempRow.vframenum = row.vframenum;
                            tempRow.venginenum = row.venginenum;
                            tempRow.vnopol=row.vnopol;
                            tempRow.dlastservice=row.dlastservice;
                            tempRow.vname=row.vname;
                            tempRow.vrelationtype=row.vrelationtype;
                            tempRow.vrelationdesc=row.vrelationdesc;
                            tempRow.vaddress=row.vaddress;
                            tempRow.vkelurahan=row.vkelurahan;
                            tempRow.vkecamatan=row.vkecamatan;
                            tempRow.vcity=row.vcity;
                            tempRow.vhpnum=row.vhpnum;
                            tempRow.vphonenum=row.vphonenum;
                            tempRow.nseqflwup=row.nseqflwup;
                            tempRow.ipembawa=row.ipembawa;
                            tempRow.vpemilik=row.vpemilik;
                            tempRow.vaddressPemilik=row.vaddressPemilik;
                            tempRow.vkelurahanPemilik=row.vkelurahanPemilik;
                            tempRow.vkecamatanPemilik=row.vkecamatanPemilik;
                            tempRow.vcityPemilik=row.vcityPemilik;
                            tempRow.vhpnumPemilik=row.vhpnumPemilik;
                            tempRow.vphonenumPemilik=row.vphonenumPemilik;
                            tempRow.ipemilikstnk=row.ipemilikstnk;
                            tempRow.vidpembawa=row.vidpembawa;
                            tempRow.vidpemilik=row.vidpemilik;
                            listDetail.push(tempRow);
                        });
                    }
                    $('#ahmdscrs003p01TableUploadresult').bootstrapTable('destroy');
                    $('#ahmdscrs003p01TableUploadresult').bootstrapTable({
                        data:listDetail
                    });
                    $('#ahmdscrs003p01Btnsave').prop('disabled',false);
                    $('#ahmdscrs003p01BtnLog').hide();
                    _fw_setMessage($('#ahmdscrs003p01Upload'), 1, json);
                    //                    $('#ahmdsh1c028p01TableTypeclr').bootstrapTable('refresh');
                } else if(json.stat == "500"){
                    url=json.rows[0];
                    $('#ahmdscrs003p01TableUploadresult').bootstrapTable('destroy');
                    $('#ahmdscrs003p01BtnLog').show();
                    _fw_setMessage($('#ahmdscrs003p01Upload'), 0, json);
                };
            });

            this.on('addedfile', function(file) {

            });

            this.on('drop', function(file) {
            
            }); 
        }
    });
    function ahmdscrs003p01Search(obj){
        //        var page = $(obj).closest('.subpage');
        //        _fw_validation_clear(obj);
        //        _fw_validation_add(obj, 'ahmdscrs003p01Servbgn', 'required');
        //        _fw_validation_add(obj, 'ahmdscrs003p01jmlFolup', 'required');
        //        if(_fw_validation_validate(obj)){
        $('#ahmdscrs003p01TableDatapembawa').bootstrapTable('refresh');
        //        }
    }
    function ahmdscrs003ToggleMonitoring(){
        $('#ahmdscrs003p01IconMonitoring').toggleClass('glyphicon-chevron-left');
        $('#ahmdscrs003p01IconMonitoring').toggleClass('glyphicon-chevron-right');
        $('#ahmdscrs003p01').toggleClass('ahmdscrs003_collapsed');
    }
    
    function ahmdscrs003p01Log(params){
        var newwindow=window.open();
        newwindow.location=url;
    }
    
    function ahmdscrs003Presearch(params){
        var dstart="";
        var dend="";
        if($('#ahmdscrs003p01ServbgnPanel').data("DateTimePicker")!=null){
            if($('#ahmdscrs003p01ServbgnPanel').data("DateTimePicker").date()!=null){
                dstart=$('#ahmdscrs003p01ServbgnPanel').data("DateTimePicker").date().locale('en').format('DD-MMM-YYYY');}
        }
        if($('#ahmdscrs003p01ServendPanel').data("DateTimePicker")!=null){
            if($('#ahmdscrs003p01ServendPanel').data("DateTimePicker").date()!=null){
                dend=$('#ahmdscrs003p01ServendPanel').data("DateTimePicker").date().locale('en').format('DD-MMM-YYYY');}
        }
        params.search = {"dstart": dstart,"dend":dend,
            "folup":$('#ahmdscrs003p01Folupoperand').val()+"-"+$('#ahmdscrs003p01jmlFolup').val(),
            "any":$('#ahmdscrs003p01Filter').val()
        };
        if(params.sort == undefined){
            return{
                limit : params.limit,
                offset : params.offset,
                search : params.search
            }
        }
        return params;
    }
    function ahmdscrs003p01PrepareAdd(obj){
        _fw_post('/crs003/typesource','',function(data){
            if(data.stat=="200"){
                $.each(data.rows, function(i, val){
                    $('#ahmdscrs003p01Sourcepembawa').append( $('<option></option>').val(val.vitemcode).html(val.vitemdesc) );
                });
            }
        });
        $('#ahmdscrs003p01Servbgn').prop('disabled',true);
        $('#ahmdscrs003p01Servend').prop('disabled',true);
        $('#ahmdscrs003p01Folupoperand').prop('disabled',true);
        $('#ahmdscrs003p01jmlFolup').prop('disabled',true);
        $('#ahmdscrs003p01Btnsearch').prop('disabled',true);
        $('#ahmdscrs003p01Btnreset').prop('disabled',true);
        $('#ahmdscrs003p01Newpanel').show();
        $('#ahmdscrs003p01TableDatapembawa').hide();
        $('#ahmdscrs003p01TableUploadresult').show();
        $('#ahmdscrs003p01Btnsave').show();
        $('#ahmdscrs003p01Btnsave').prop('disabled',true);
        $('#ahmdscrs003p01BtnLog').hide();
        $('#ahmdscrs003p01Btncancel').show();
        $('#ahmdscrs003p01Filter').prop('disabled',true);
        $('#ahmdscrs003p01TableUploadresult').bootstrapTable('removeAll');
        
    }
    function ahmdscrs003p01Cancel(obj){
        $('#ahmdscrs003p01Servbgn').prop('disabled',false);
        $('#ahmdscrs003p01Servend').prop('disabled',false);
        $('#ahmdscrs003p01Folupoperand').prop('disabled',false);
        $('#ahmdscrs003p01jmlFolup').prop('disabled',false);
        $('#ahmdscrs003p01Btnsearch').prop('disabled',false);
        $('#ahmdscrs003p01Btnreset').prop('disabled',false);
        $('#ahmdscrs003p01Newpanel').hide();
        $('#ahmdscrs003p01TableDatapembawa').show();
        $('#ahmdscrs003p01TableUploadresult').hide();
        $('#ahmdscrs003p01Btnsave').hide();
        $('#ahmdscrs003p01BtnLog').hide();
        $('#ahmdscrs003p01Btncancel').hide();
        $('#ahmdscrs003p01Filter').prop('disabled',false);
    }
    function ahmdscrs003p01Download(obj){
        _fw_post("/crs003/gettemplate", '', function(data){
            if(data.stat == "200"){                    
                var url=data.rows[0];
                var newwindow=window.open();
                newwindow.location=url;
                _fw_setMessage(obj, 1, data);
            } else {
                alert('no template available');
            }
        });
    }
    function ahmdscrs003p01Save(obj){
        var tabContent = $('#ahmdscrs003p01TableUploadresult').bootstrapTable('getData');
        if(tabContent.length > 0){
            vo=new Object();
            vo.vsource=$('#ahmdscrs003p01Sourcepembawa').val();
            vo.listPembawas=tabContent;
            _fw_post('/crs003/save',vo,function(data){
                if(data.stat=="200"){
                    var page = $('#ahmdscrs003p02');
                    $('#ahmdscrs003p02AddJobdate').prop('disabled',true);
                    $('#ahmdscrs003p02Addpartner').prop('disabled',true);
                    $('#ahmdscrs003p02AddpartnerBtn').prop('disabled',true);
                    $('button[id="ahmdscrs003p02BtnSubmitHeader"]', page).hide();
                    $('button[id="ahmdscrs003p02BtnAddDetail"]', page).show();
                    $('#ahmdscrs003p02AddVidhdr').val(data.rows[0].vid);
                    $('#ahmdscrs003p02AddJoborderno').val(data.rows[0].vidjobnum);
                    _fw_setMessage(obj,1,data);
                } else {
                    _fw_setMessage(obj,0,data);
                }
            });
        }
    }
</script>